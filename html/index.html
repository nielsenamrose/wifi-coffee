<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Wi-Fi coffee</title>
    <link rel="icon" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="stylesheet" href="stylesheet.css" type="text/css">
  </head>
  <body>
    <img id="background" src="background.jpg"></img>
    <img id="grinder" src="grinder.png"></img>
    <div id="grinderLabel"></div>
    <div id="circle"></div>    
    <div id="errorMessage"></div>
    <script>
      const img = document.querySelector("#background");
      const grinder = document.querySelector("#grinder"); 
      const grinderLabel = document.querySelector("#grinderLabel"); 
      const circle = document.querySelector("#circle");
      const errorMessage = document.querySelector("#errorMessage");
      
      var heating = false;
      var ready = false;
      var toggle = true;
      var interval = undefined;
      var grinderRuns = 0;

      updateCircle = function () {
        const ratio = img.naturalWidth / img.naturalHeight;
        var width = img.height * ratio;
        if (width > img.width) {
          width = img.width;
        }
        const r = width*0.245;
        const b = width*0.0564;
        //console.log(`width=${width} r=${r}`);
        circle.style.width = `${2 * r}px`;
        circle.style.height = `${2 * r}px`;
        circle.style.transform = `translate(${img.width / 2 - r - b}px, ${img.height / 2 - r - b}px)`;
        circle.style["border-width"] = `${b}px`;
      };

      emitError = function(message) {
        errorMessage.innerHTML = message;
      }

      update = function(data) {
        console.log(data);
        heating = data.heating,
        ready = data.ready,
        grinderRuns = data.grinderRuns;
        grinderLabel.innerHTML = grinderRuns;
        errorMessage.innerHTML = "";
        if (!heating) circle.classList.toggle("on", ready);
      }

      callApi = function(method) {
        fetch("http://192.168.1.15:8081/api/" + method)
            .then(response => response.json())
            .then(data => update(data))
            .catch(error => emitError(`Error: ${error.message}`));
      }

      start = function(){
        if (interval) clearInterval(interval);
        interval = setInterval(() => {
          callApi("read");
          if (heating) circle.classList.toggle("on");
        }, 500);
      }

      window.addEventListener("resize", updateCircle);
      window.addEventListener("load", updateCircle);
            
      grinder.addEventListener("click", () => callApi("pushGrinder"));
      circle.addEventListener("click", () => {callApi("pushPower"); start();});

      start();
    </script>
  </body>
</html>