<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Wi-Fi coffee</title>
    <link rel="icon" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="stylesheet" href="stylesheet.css" type="text/css">
  </head>
  <body>
    <img id="background" src="background.jpg"></img>
    <img id="grinder" src="grinder.png"></img>
    <div id="circle"></div>    
    <div id="errorMessage"></div>
    <script>
      const img = document.querySelector("#background");
      const grinder = document.querySelector("#grinder"); 
      const circle = document.querySelector("#circle");
      const errorMessage = document.querySelector("#errorMessage");
      
      var value = false;
      var age = undefined;
      var toggle = true;
      var interval = undefined;

      updateCircle = function () {
        const ratio = img.naturalWidth / img.naturalHeight;
        var width = img.height * ratio;
        if (width > img.width) {
          width = img.width;
        }
        const r = width*0.245;
        const b = width*0.0564;
        //console.log(`width=${width} r=${r}`);
        circle.style.width = `${2 * r}px`;
        circle.style.height = `${2 * r}px`;
        circle.style.transform = `translate(${img.width / 2 - r - b}px, ${img.height / 2 - r - b}px)`;
        circle.style["border-width"] = `${b}px`;
      };

      emitError = function(message) {
        errorMessage.innerHTML = message;
      }

      start = function(){
        if (interval) clearInterval(interval);
        interval = setInterval(() => {
          fetch("http://192.168.1.17:8081/api/read")
            .then(response => response.json())
            .then(data => {
              value = data.value == 1; 
              age = data.age
              if (value) toggle = true;
              if (age >= 10000) circle.classList.toggle("on", value);
              emitError("");
            }).catch(error => emitError(`Error: ${error.message}`));
          if (toggle && age < 10000) circle.classList.toggle("on");
        }, 500);
      }

      window.addEventListener("resize", updateCircle);
      window.addEventListener("load", updateCircle);
            
      grinder.addEventListener("click", () => {
        fetch("http://192.168.1.17:8081/api/pushGrinder")
          .then(response => {})
          .catch(error => emitError(`Error: ${error.message}`));
      });

      circle.addEventListener("click", () => {
        fetch("http://192.168.1.17:8081/api/pushPower")
          .then(response => {
            value = toggle = !value;
            age = 0;
            circle.classList.toggle("on", value);
            start();
            emitError("");
          }).catch(error => emitError(`Error: ${error.message}`));
      });

      start();
    </script>
  </body>
</html>